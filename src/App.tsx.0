import React, { useState, useEffect } from 'react';
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

// Types
interface Player {
  number: number;
  name: string;
}

interface ScoreEvent {
  id: string;
  timestamp: number;
  team: 'home' | 'away';
  type: 'try' | 'conversion' | 'penalty' | 'drop-goal' | 'penalty-try';
  points: number;
  player?: number;
  half: number;
  minute: number;
}

interface Card {
  id: string;
  timestamp: number;
  team: 'home' | 'away';
  player: number;
  type: 'yellow' | 'red';
  half: number;
  minute: number;
  returnTime?: number;
}

interface MatchState {
  homeTeam: string;
  awayTeam: string;
  homeScore: number;
  awayScore: number;
  scoreEvents: ScoreEvent[];
  cards: Card[];
  currentHalf: number;
  elapsedSeconds: number;
  isRunning: boolean;
  halfDuration: number;
  lastTryTeam: 'home' | 'away' | null;
}

// Zustand Store
const useMatchStore = create<MatchState & {
  addScore: (team: 'home' | 'away', type: ScoreEvent['type'], player?: number) => void;
  addCard: (team: 'home' | 'away', player: number, type: 'yellow' | 'red') => void;
  undo: () => void;
  toggleTimer: () => void;
  tick: () => void;
  nextHalf: () => void;
  reset: () => void;
  setTeamName: (team: 'home' | 'away', name: string) => void;
}>(
  persist(
    (set, get) => ({
      homeTeam: 'Home',
      awayTeam: 'Away',
      homeScore: 0,
      awayScore: 0,
      scoreEvents: [],
      cards: [],
      currentHalf: 1,
      elapsedSeconds: 0,
      isRunning: false,
      halfDuration: 40 * 60,
      lastTryTeam: null,

      setTeamName: (team, name) => set({ [team === 'home' ? 'homeTeam' : 'awayTeam']: name }),

      addScore: (team, type, player) => {
        const state = get();
        
        // Prevent conversion if no recent try
        if (type === 'conversion' && state.lastTryTeam !== team) return;

        const points = {
          'try': 5,
          'conversion': 2,
          'penalty': 3,
          'drop-goal': 3,
          'penalty-try': 7,
        }[type];

        const event: ScoreEvent = {
          id: crypto.randomUUID(),
          timestamp: Date.now(),
          team,
          type,
          points,
          player,
          half: state.currentHalf,
          minute: Math.floor(state.elapsedSeconds / 60),
        };

        const scoreKey = team === 'home' ? 'homeScore' : 'awayScore';
        
        set({
          [scoreKey]: state[scoreKey] + points,
          scoreEvents: [...state.scoreEvents, event],
          lastTryTeam: type === 'try' || type === 'penalty-try' ? team : null,
        });
      },

      addCard: (team, player, type) => {
        const state = get();
        const card: Card = {
          id: crypto.randomUUID(),
          timestamp: Date.now(),
          team,
          player,
          type,
          half: state.currentHalf,
          minute: Math.floor(state.elapsedSeconds / 60),
          returnTime: type === 'yellow' ? state.elapsedSeconds + 600 : undefined,
        };

        set({ cards: [...state.cards, card] });
      },

      undo: () => {
        const state = get();
        const lastEvent = state.scoreEvents[state.scoreEvents.length - 1];
        const lastCard = state.cards[state.cards.length - 1];
        
        const lastEventTime = lastEvent?.timestamp || 0;
        const lastCardTime = lastCard?.timestamp || 0;

        if (lastEventTime > lastCardTime && lastEvent) {
          const scoreKey = lastEvent.team === 'home' ? 'homeScore' : 'awayScore';
          set({
            [scoreKey]: state[scoreKey] - lastEvent.points,
            scoreEvents: state.scoreEvents.slice(0, -1),
            lastTryTeam: lastEvent.type === 'conversion' ? lastEvent.team : 
                        state.scoreEvents[state.scoreEvents.length - 2]?.type === 'try' ? 
                        state.scoreEvents[state.scoreEvents.length - 2].team : null,
          });
        } else if (lastCard) {
          set({ cards: state.cards.slice(0, -1) });
        }
      },

      toggleTimer: () => set((state) => ({ isRunning: !state.isRunning })),

      tick: () => set((state) => 
        state.isRunning ? { elapsedSeconds: state.elapsedSeconds + 1 } : {}
      ),

      nextHalf: () => set((state) => ({
        currentHalf: state.currentHalf + 1,
        elapsedSeconds: 0,
        isRunning: false,
      })),

      reset: () => set({
        homeScore: 0,
        awayScore: 0,
        scoreEvents: [],
        cards: [],
        currentHalf: 1,
        elapsedSeconds: 0,
        isRunning: false,
        lastTryTeam: null,
      }),
    }),
    {
      name: 'rugby-match-storage',
    }
  )
);

// Timer Effect
const useTimer = () => {
  const tick = useMatchStore((state) => state.tick);
  
  useEffect(() => {
    const interval = setInterval(tick, 1000);
    return () => clearInterval(interval);
  }, [tick]);
};

// Format time
const formatTime = (seconds: number) => {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
};

// Components
const ScoreButton: React.FC<{
  label: string;
  points: number;
  onClick: () => void;
  disabled?: boolean;
  variant?: 'primary' | 'secondary' | 'penalty';
}> = ({ label, points, onClick, disabled, variant = 'primary' }) => {
  const bgColor = disabled ? 'bg-zinc-700' : 
                 variant === 'penalty' ? 'bg-amber-600 active:bg-amber-700' :
                 variant === 'secondary' ? 'bg-emerald-600 active:bg-emerald-700' :
                 'bg-blue-600 active:bg-blue-700';
  
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={`${bgColor} text-white font-black text-lg p-4 rounded-lg
                  transition-all duration-75 shadow-lg
                  ${disabled ? 'opacity-40 cursor-not-allowed' : 'active:scale-95 active:shadow-md'}`}
    >
      <div className="text-sm opacity-80 font-bold">{label}</div>
      <div className="text-3xl">+{points}</div>
    </button>
  );
};

const CardButton: React.FC<{
  type: 'yellow' | 'red';
  onClick: () => void;
}> = ({ type, onClick }) => (
  <button
    onClick={onClick}
    className={`${type === 'yellow' ? 'bg-yellow-400' : 'bg-red-600'} 
                text-black font-black text-sm p-3 rounded-lg
                transition-all duration-75 shadow-lg active:scale-95`}
  >
    {type === 'yellow' ? 'üü®' : 'üü•'} {type.toUpperCase()}
  </button>
);

const TeamSection: React.FC<{
  team: 'home' | 'away';
  isTop?: boolean;
}> = ({ team, isTop = false }) => {
  const [showPlayerPicker, setShowPlayerPicker] = useState(false);
  const [selectedAction, setSelectedAction] = useState<'score' | 'card' | null>(null);
  const [scoreType, setScoreType] = useState<ScoreEvent['type']>('try');
  const [cardType, setCardType] = useState<'yellow' | 'red'>('yellow');
  const [playerNum, setPlayerNum] = useState('');

  const teamName = useMatchStore((state) => team === 'home' ? state.homeTeam : state.awayTeam);
  const score = useMatchStore((state) => team === 'home' ? state.homeScore : state.awayScore);
  const lastTryTeam = useMatchStore((state) => state.lastTryTeam);
  const addScore = useMatchStore((state) => state.addScore);
  const addCard = useMatchStore((state) => state.addCard);
  const setTeamName = useMatchStore((state) => state.setTeamName);

  const canConvert = lastTryTeam === team;

  const handleScoreClick = (type: ScoreEvent['type']) => {
    if (type === 'penalty-try') {
      addScore(team, type);
    } else {
      setScoreType(type);
      setSelectedAction('score');
      setShowPlayerPicker(true);
    }
  };

  const handleCardClick = (type: 'yellow' | 'red') => {
    setCardType(type);
    setSelectedAction('card');
    setShowPlayerPicker(true);
  };

  const handlePlayerSubmit = () => {
    const num = parseInt(playerNum);
    if (!num || num < 1 || num > 23) return;

    if (selectedAction === 'score') {
      addScore(team, scoreType, num);
    } else if (selectedAction === 'card') {
      addCard(team, num, cardType);
    }

    setShowPlayerPicker(false);
    setPlayerNum('');
  };

  return (
    <div className={`relative ${isTop ? 'pb-6' : 'pt-6'}`}>
      {/* Team Header */}
      <div className={`flex items-center justify-between mb-4 ${isTop ? 'flex-col-reverse' : 'flex-col'}`}>
        <input
          type="text"
          value={teamName}
          onChange={(e) => setTeamName(team, e.target.value)}
          className="bg-transparent text-white font-black text-2xl text-center border-b-2 border-transparent
                     focus:border-white focus:outline-none w-full mb-2 px-2"
        />
        <div className="text-white font-black text-7xl tracking-tighter">{score}</div>
      </div>

      {/* Score Actions */}
      <div className="grid grid-cols-2 gap-3 mb-3">
        <ScoreButton label="TRY" points={5} onClick={() => handleScoreClick('try')} />
        <ScoreButton 
          label="CONVERSION" 
          points={2} 
          onClick={() => handleScoreClick('conversion')}
          disabled={!canConvert}
          variant="secondary"
        />
        <ScoreButton label="PENALTY" points={3} onClick={() => handleScoreClick('penalty')} variant="penalty" />
        <ScoreButton label="DROP GOAL" points={3} onClick={() => handleScoreClick('drop-goal')} variant="penalty" />
      </div>
      
      {/* Penalty Try */}
      <button
        onClick={() => handleScoreClick('penalty-try')}
        className="w-full bg-red-700 text-white font-black text-sm p-3 rounded-lg mb-3
                   transition-all duration-75 shadow-lg active:scale-95"
      >
        PENALTY TRY (+7)
      </button>

      {/* Cards */}
      <div className="grid grid-cols-2 gap-3">
        <CardButton type="yellow" onClick={() => handleCardClick('yellow')} />
        <CardButton type="red" onClick={() => handleCardClick('red')} />
      </div>

      {/* Player Number Picker */}
      {showPlayerPicker && (
        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
          <div className="bg-zinc-900 rounded-2xl p-6 w-full max-w-sm border-4 border-white">
            <h3 className="text-white font-black text-2xl mb-4 text-center">
              {selectedAction === 'score' ? `${scoreType.toUpperCase()}` : `${cardType.toUpperCase()} CARD`}
            </h3>
            <p className="text-zinc-400 text-sm mb-4 text-center font-bold">Enter player number (1-23)</p>
            
            <input
              type="number"
              inputMode="numeric"
              min="1"
              max="23"
              value={playerNum}
              onChange={(e) => setPlayerNum(e.target.value)}
              className="w-full bg-zinc-800 text-white text-4xl font-black text-center p-4 rounded-lg
                         border-2 border-zinc-700 focus:border-white focus:outline-none mb-4"
              autoFocus
            />
            
            <div className="grid grid-cols-2 gap-3">
              <button
                onClick={() => {
                  setShowPlayerPicker(false);
                  setPlayerNum('');
                }}
                className="bg-zinc-700 text-white font-black p-4 rounded-lg active:bg-zinc-600"
              >
                CANCEL
              </button>
              <button
                onClick={handlePlayerSubmit}
                disabled={!playerNum || parseInt(playerNum) < 1 || parseInt(playerNum) > 23}
                className="bg-blue-600 text-white font-black p-4 rounded-lg active:bg-blue-700
                           disabled:opacity-40 disabled:cursor-not-allowed"
              >
                CONFIRM
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const MatchControls: React.FC = () => {
  const [showMenu, setShowMenu] = useState(false);
  const currentHalf = useMatchStore((state) => state.currentHalf);
  const elapsedSeconds = useMatchStore((state) => state.elapsedSeconds);
  const isRunning = useMatchStore((state) => state.isRunning);
  const halfDuration = useMatchStore((state) => state.halfDuration);
  const toggleTimer = useMatchStore((state) => state.toggleTimer);
  const nextHalf = useMatchStore((state) => state.nextHalf);
  const undo = useMatchStore((state) => state.undo);
  const reset = useMatchStore((state) => state.reset);

  const isOvertime = elapsedSeconds > halfDuration;

  return (
    <div className="sticky top-0 bg-zinc-900/95 backdrop-blur-sm z-40 border-y-4 border-white py-3">
      <div className="flex items-center justify-between px-4">
        {/* Undo */}
        <button
          onClick={undo}
          className="bg-zinc-800 text-white font-black text-sm px-4 py-3 rounded-lg
                     active:bg-zinc-700 active:scale-95 transition-all shadow-lg"
        >
          ‚Ü∂ UNDO
        </button>

        {/* Timer */}
        <div className="flex items-center gap-3">
          <button
            onClick={toggleTimer}
            className={`${isRunning ? 'bg-red-600' : 'bg-green-600'} 
                       text-white font-black px-6 py-3 rounded-lg
                       active:scale-95 transition-all shadow-lg`}
          >
            {isRunning ? '‚è∏' : '‚ñ∂'}
          </button>
          
          <div className="text-center">
            <div className="text-white font-black text-xs opacity-60">
              HALF {currentHalf}
            </div>
            <div className={`font-black text-2xl tracking-tighter ${isOvertime ? 'text-red-400' : 'text-white'}`}>
              {formatTime(elapsedSeconds)}
              {isOvertime && <span className="text-red-400 text-sm ml-1">+{formatTime(elapsedSeconds - halfDuration)}</span>}
            </div>
          </div>
        </div>

        {/* Menu */}
        <button
          onClick={() => setShowMenu(true)}
          className="bg-zinc-800 text-white font-black text-sm px-4 py-3 rounded-lg
                     active:bg-zinc-700 active:scale-95 transition-all shadow-lg"
        >
          ‚ãØ
        </button>
      </div>

      {/* Menu Modal */}
      {showMenu && (
        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
          <div className="bg-zinc-900 rounded-2xl p-6 w-full max-w-sm border-4 border-white">
            <h3 className="text-white font-black text-2xl mb-6">MATCH CONTROLS</h3>
            
            <div className="space-y-3">
              <button
                onClick={() => {
                  nextHalf();
                  setShowMenu(false);
                }}
                className="w-full bg-blue-600 text-white font-black p-4 rounded-lg active:bg-blue-700"
              >
                NEXT HALF
              </button>
              
              <button
                onClick={() => {
                  if (confirm('Reset the entire match? This cannot be undone.')) {
                    reset();
                    setShowMenu(false);
                  }
                }}
                className="w-full bg-red-600 text-white font-black p-4 rounded-lg active:bg-red-700"
              >
                RESET MATCH
              </button>
              
              <button
                onClick={() => setShowMenu(false)}
                className="w-full bg-zinc-700 text-white font-black p-4 rounded-lg active:bg-zinc-600"
              >
                CLOSE
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const EventLog: React.FC = () => {
  const [showLog, setShowLog] = useState(false);
  const scoreEvents = useMatchStore((state) => state.scoreEvents);
  const cards = useMatchStore((state) => state.cards);
  const homeTeam = useMatchStore((state) => state.homeTeam);
  const awayTeam = useMatchStore((state) => state.awayTeam);

  const allEvents = [...scoreEvents, ...cards]
    .sort((a, b) => b.timestamp - a.timestamp);

  return (
    <>
      <button
        onClick={() => setShowLog(true)}
        className="fixed bottom-4 right-4 bg-zinc-800 text-white font-black text-sm px-5 py-3 rounded-full
                   shadow-2xl active:scale-95 transition-all z-30 border-2 border-white"
      >
        üìã LOG ({allEvents.length})
      </button>

      {showLog && (
        <div className="fixed inset-0 bg-black/95 z-50 overflow-auto">
          <div className="p-4">
            <div className="flex justify-between items-center mb-6 sticky top-0 bg-black py-4">
              <h2 className="text-white font-black text-3xl">MATCH LOG</h2>
              <button
                onClick={() => setShowLog(false)}
                className="bg-zinc-800 text-white font-black px-4 py-2 rounded-lg"
              >
                CLOSE
              </button>
            </div>

            <div className="space-y-2">
              {allEvents.map((event) => {
                const isScore = 'points' in event;
                const teamName = event.team === 'home' ? homeTeam : awayTeam;
                
                return (
                  <div
                    key={event.id}
                    className="bg-zinc-900 border-l-4 border-white p-4 rounded-lg"
                  >
                    <div className="flex justify-between items-start">
                      <div>
                        <div className="text-white font-black text-lg">
                          {teamName}
                          {event.player && ` #${event.player}`}
                        </div>
                        <div className="text-zinc-400 font-bold text-sm">
                          {isScore ? (
                            <>
                              {(event as ScoreEvent).type.toUpperCase()} 
                              <span className="text-green-400 ml-2">+{(event as ScoreEvent).points}</span>
                            </>
                          ) : (
                            <span className={(event as Card).type === 'yellow' ? 'text-yellow-400' : 'text-red-400'}>
                              {(event as Card).type.toUpperCase()} CARD
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="text-zinc-500 text-sm font-bold text-right">
                        H{event.half}<br/>{event.minute}'
                      </div>
                    </div>
                  </div>
                );
              })}

              {allEvents.length === 0 && (
                <div className="text-zinc-600 text-center py-12 font-bold">
                  No events yet
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </>
  );
};

// Main App
const App: React.FC = () => {
  useTimer();

  return (
    <div className="min-h-screen bg-zinc-950 text-white overflow-hidden">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Condensed:wght@400;700;900&display=swap');
        
        * {
          font-family: 'Roboto Condensed', sans-serif;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        
        input[type="number"] {
          -moz-appearance: textfield;
        }

        /* Prevent zoom on input focus (iOS) */
        input {
          font-size: 16px;
        }
      `}</style>

      <div className="max-w-2xl mx-auto">
        {/* Away Team (Top) */}
        <div className="bg-gradient-to-b from-zinc-900 to-zinc-950 p-4">
          <TeamSection team="away" isTop />
        </div>

        {/* Controls */}
        <MatchControls />

        {/* Home Team (Bottom) */}
        <div className="bg-gradient-to-t from-zinc-900 to-zinc-950 p-4">
          <TeamSection team="home" />
        </div>
      </div>

      {/* Event Log */}
      <EventLog />
    </div>
  );
};

export default App;
